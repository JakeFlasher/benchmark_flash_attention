
# Export environment variables directly like your working script
export CUDA_VISIBLE_DEVICES=$gpu_id
export LD_LIBRARY_PATH=$(dirname $(python -c 'import torch; print(torch.__file__)'))/lib/

mkdir -p ./results_standard
mkdir -p ./results_varlen
mkdir -p ./results_kvcache
mkdir -p ./ncu_reports/standard
mkdir -p ./ncu_reports/varlen
mkdir -p ./ncu_reports/kvcache

# =====================================================
# STANDARD ATTENTION BENCHMARKS
# =====================================================

echo "===== STANDARD ATTENTION BENCHMARKS ====="
===== STANDARD ATTENTION BENCHMARKS =====

# Modern LLM model configurations
echo "Testing modern LLM configurations..."
Testing modern LLM configurations...
# Window attention tests
echo "Testing sliding window attention..."
Testing sliding window attention...
S=1 Hqo=32 Hkv=8 D=128
for W in 128 512 1024; do
  # Define output files directly without using process substitution
  ncu_file="./ncu_reports/standard/window-$W.ncu-rep"
  md_file="./ncu_reports/standard/window-$W.md"
  
  # Match the exact format and ordering of the working script
  $ncu_path --metrics \
l1tex__t_sector_hit_rate.pct,\
l1tex__t_sector_pipe_lsu_mem_global_op_ld_hit_rate.pct,\
lts__t_sector_hit_rate.pct,\
l1tex__t_requests_pipe_lsu_mem_global_op_ld.sum,\
l1tex__t_requests_pipe_lsu_mem_global_op_st.sum,\
l1tex__t_requests_pipe_lsu_mem_local_op_ld.sum,\
l1tex__t_requests_pipe_lsu_mem_local_op_st.sum,\
l1tex__t_requests_pipe_tex_mem_surface_op_ld.sum,\
l1tex__t_requests_pipe_tex_mem_texture.sum,\
l1tex__t_requests_pipe_tex_mem_surface_op_st.sum,\
l1tex__t_requests_pipe_lsu_mem_global_op_red.sum,\
l1tex__t_requests_pipe_tex_mem_surface_op_red.sum,\
l1tex__t_requests_pipe_lsu_mem_global_op_atom.sum,\
l1tex__t_requests_pipe_tex_mem_surface_op_atom.sum,\
l1tex__t_sectors_pipe_lsu_mem_global_op_ld.sum,\
l1tex__t_sectors_pipe_lsu_mem_global_op_st.sum,\
l1tex__m_xbar2l1tex_read_sectors_mem_lg_op_ld.sum,\
l1tex__m_l1tex2xbar_write_sectors_mem_lg_op_st.sum,\
lts__t_requests_srcunit_tex.sum,\
dram__sectors_read.sum,\
dram__sectors_write.sum,\
dram__bytes.sum.per_second,\
gpc__cycles_elapsed.max,\
sm__cycles_active.avg,\
gpc__cycles_elapsed.avg.per_second,\
dram__cycles_elapsed.avg.per_second,\
gpu__time_duration.sum,\
sm__inst_executed.avg.per_cycle_elapsed,\
smsp__inst_executed.sum,\
gpu__compute_memory_access_throughput.avg.pct_of_peak_sustained_elapsed,\
gpu__compute_memory_request_throughput.avg.pct_of_peak_sustained_elapsed,\
sm__memory_throughput.avg.pct_of_peak_sustained_elapsed,\
launch__occupancy_limit_blocks,\
launch__occupancy_limit_registers,\
launch__occupancy_limit_shared_mem,\
launch__occupancy_limit_warps,\
sm__maximum_warps_avg_per_active_cycle,\
sm__maximum_warps_per_active_cycle_pct,\
sm__warps_active.avg.per_cycle_active,\
sm__warps_active.avg.pct_of_peak_sustained_active \
  --profile-from-start on \
  --export "$ncu_file" \
  --force-overwrite \
  --clock-control base \
  --replay-mode kernel \
  ./build/flash_attention_benchmark_standard \
  -a num_seqs=$S -a num_heads=$Hqo -a num_kv_heads=$Hkv -a head_size=$D \
  -a window_left=$W -a window_right=$W \
  --disable-blocking-kernel --md "$md_file"
done
==PROF== Connected to process 8846 (/home/accel-sim-framework/util/tracer_nvbit/applications/benchmark_flash_attention/build/flash_attention_benchmark_standard)
# Devices

## [0] `NVIDIA A30`
* SM Version: 800 (PTX Version: 800)
* Number of SMs: 56
* SM Default Clock Rate: 1440 MHz
* Global Memory: 23651 MiB Free / 24060 MiB Total
* Global Memory Bus Peak: 933 GB/sec (3072-bit DDR @1215MHz)
* Max Shared Memory: 164 KiB/SM, 48 KiB/Block
* L2 Cache Size: 24576 KiB
* Maximum Active Blocks: 32/SM
* Maximum Active Threads: 2048/SM, 1024/Block
* Available Registers: 65536/SM, 65536/Block
* ECC Enabled: Yes

# Log

```
Run:  [1/10] run_mha_fwd [Device=0 num_seqs=1 seq_len=512 num_heads=32 num_kv_heads=8 head_size=128 window_left=128 window_right=128 causal=0]
==PROF== Profiling "distribution_elementwise_grid..." - 0: 0%....50%....100% - 13 passes
==PROF== Profiling "distribution_elementwise_grid..." - 1: 0%....50%....100% - 13 passes
==PROF== Profiling "distribution_elementwise_grid..." - 2: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 3: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 4: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 5: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 6: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 7: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 8: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 9: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 10: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 11: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 12: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 13: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 14: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 15: 0%....50%....100% - 13 passes
Warn: Current measurement timed out (16.30s) while over noise threshold (1.93% > 0.50%)
Pass: Cold: 1357.898163ms GPU, 1357.920647ms CPU, 16.29s total GPU, 16.30s total wall, 12x 
==PROF== Profiling "flash_fwd_kernel" - 16: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 17: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 18: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 19: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 20: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 21: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 22: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 23: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 24: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 25: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 26: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 27: 0%....50%....100% - 13 passes
Warn: Current measurement timed out (15.21s) before accumulating min_samples (11 < 12)
Pass: Batch: 1382.850009ms GPU, 15.21s total GPU, 15.21s total wall, 11x
Run:  [2/10] run_mha_fwd [Device=0 num_seqs=1 seq_len=1024 num_heads=32 num_kv_heads=8 head_size=128 window_left=128 window_right=128 causal=0]
==PROF== Profiling "distribution_elementwise_grid..." - 28: 0%....50%....100% - 13 passes
==PROF== Profiling "distribution_elementwise_grid..." - 29: 0%....50%....100% - 13 passes
==PROF== Profiling "distribution_elementwise_grid..." - 30: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 31: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 32: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 33: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 34: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 35: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 36: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 37: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 38: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 39: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 40: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 41: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 42: 0%....50%....100% - 13 passes
Warn: Current measurement timed out (15.17s) while over noise threshold (2.59% > 0.50%)
Pass: Cold: 1379.213701ms GPU, 1379.236249ms CPU, 15.17s total GPU, 15.17s total wall, 11x 
==PROF== Profiling "flash_fwd_kernel" - 43: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 44: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 45: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 46: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 47: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 48: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 49: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 50: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 51: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 52: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 53: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 54: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 55: 0%....50%....100% - 13 passes
Pass: Batch: 1359.886943ms GPU, 16.32s total GPU, 16.32s total wall, 12x
Run:  [3/10] run_mha_fwd [Device=0 num_seqs=1 seq_len=2048 num_heads=32 num_kv_heads=8 head_size=128 window_left=128 window_right=128 causal=0]
==PROF== Profiling "distribution_elementwise_grid..." - 56: 0%....50%....100% - 13 passes
==PROF== Profiling "distribution_elementwise_grid..." - 57: 0%....50%....100% - 13 passes
==PROF== Profiling "distribution_elementwise_grid..." - 58: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 59: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 60: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 61: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 62: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 63: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 64: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 65: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 66: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 67: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 68: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 69: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 70: 0%....50%....100% - 13 passes
Warn: Current measurement timed out (15.03s) while over noise threshold (1.22% > 0.50%)
Pass: Cold: 1366.001587ms GPU, 1366.024337ms CPU, 15.03s total GPU, 15.03s total wall, 11x 
==PROF== Profiling "flash_fwd_kernel" - 71: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 72: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 73: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 74: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 75: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 76: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 77: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 78: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 79: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 80: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 81: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 82: 0%....50%....100% - 13 passes
Pass: Batch: 1376.611239ms GPU, 15.14s total GPU, 15.14s total wall, 11x
Run:  [4/10] run_mha_fwd [Device=0 num_seqs=1 seq_len=4096 num_heads=32 num_kv_heads=8 head_size=128 window_left=128 window_right=128 causal=0]
==PROF== Profiling "distribution_elementwise_grid..." - 83: 0%....50%....100% - 13 passes
==PROF== Profiling "distribution_elementwise_grid..." - 84: 0%....50%....100% - 13 passes
==PROF== Profiling "distribution_elementwise_grid..." - 85: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 86: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 87: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 88: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 89: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 90: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 91: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 92: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 93: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 94: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 95: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 96: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 97: 0%....50%....100% - 13 passes
Warn: Current measurement timed out (15.02s) while over noise threshold (1.10% > 0.50%)
Pass: Cold: 1365.414628ms GPU, 1365.437891ms CPU, 15.02s total GPU, 15.02s total wall, 11x 
==PROF== Profiling "flash_fwd_kernel" - 98: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 99: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 100: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 101: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 102: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 103: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 104: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 105: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 106: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 107: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 108: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 109: 0%....50%....100% - 13 passes
Pass: Batch: 1412.113315ms GPU, 15.53s total GPU, 15.53s total wall, 11x
Run:  [5/10] run_mha_fwd [Device=0 num_seqs=1 seq_len=8192 num_heads=32 num_kv_heads=8 head_size=128 window_left=128 window_right=128 causal=0]
==PROF== Profiling "distribution_elementwise_grid..." - 110: 0%....50%....100% - 13 passes
==PROF== Profiling "distribution_elementwise_grid..." - 111: 0%....50%....100% - 13 passes
==PROF== Profiling "distribution_elementwise_grid..." - 112: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 113: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 114: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 115: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 116: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 117: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 118: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 119: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 120: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 121: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 122: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 123: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 124: 0%....50%....100% - 13 passes
Warn: Current measurement timed out (15.26s) while over noise threshold (1.95% > 0.50%)
Pass: Cold: 1387.083774ms GPU, 1387.107426ms CPU, 15.26s total GPU, 15.26s total wall, 11x 
==PROF== Profiling "flash_fwd_kernel" - 125: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 126: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 127: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 128: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 129: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 130: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 131: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 132: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 133: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 134: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 135: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 136: 0%....50%....100% - 13 passes
Pass: Batch: 1384.846680ms GPU, 15.23s total GPU, 15.23s total wall, 11x
Run:  [6/10] run_mha_fwd [Device=0 num_seqs=1 seq_len=512 num_heads=32 num_kv_heads=8 head_size=128 window_left=128 window_right=128 causal=1]
==PROF== Profiling "distribution_elementwise_grid..." - 137: 0%....50%....100% - 13 passes
==PROF== Profiling "distribution_elementwise_grid..." - 138: 0%....50%....100% - 13 passes
==PROF== Profiling "distribution_elementwise_grid..." - 139: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 140: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 141: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 142: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 143: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 144: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 145: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 146: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 147: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 148: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 149: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 150: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 151: 0%....50%....100% - 13 passes
Warn: Current measurement timed out (15.04s) while over noise threshold (1.41% > 0.50%)
Pass: Cold: 1367.063454ms GPU, 1367.087028ms CPU, 15.04s total GPU, 15.04s total wall, 11x 
==PROF== Profiling "flash_fwd_kernel" - 152: 0%....50%....100% - 13 passes
==PROF== Profiling "flash_fwd_kernel" - 153: 0%....50%....100% - 13 passes
==ERROR== Failed to save the report to file /home/accel-sim-framework/util/tracer_nvbit/applications/benchmark_flash_attention/./ncu_reports/standard/window-128.ncu-rep
==PROF== Profiling "flash_fwd_kernel" - 154: 0%....50%....100% - 13 passes
==ERROR== Failed to save the report to file /home/accel-sim-framework/util/tracer_nvbit/applications/benchmark_flash_attention/./ncu_reports/standard/window-128.ncu-rep
==PROF== Profiling "flash_fwd_kernel" - 155: 0%....50%....100% - 13 passes
==ERROR== Failed to save the report to file /home/accel-sim-framework/util/tracer_nvbit/applications/benchmark_flash_attention/./ncu_reports/standard/window-128.ncu-rep
==PROF== Profiling "flash_fwd_kernel" - 156: 0%....50%....100% - 13 passes
==ERROR== Failed to save the report to file /home/accel-sim-framework/util/tracer_nvbit/applications/benchmark_flash_attention/./ncu_reports/standard/window-128.ncu-rep
==PROF== Profiling "flash_fwd_kernel" - 157: 0%....50%....100% - 13 passes
==ERROR== Failed to save the report to file /home/accel-sim-framework/util/tracer_nvbit/applications/benchmark_flash_attention/./ncu_reports/standard/window-128.ncu-rep
==PROF== Profiling "flash_fwd_kernel" - 158: 